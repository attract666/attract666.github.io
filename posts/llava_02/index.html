<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>从零开始学LLaVA 02 | JiaHe&#39;s Blog</title>
<meta name="keywords" content="vision-language-models, LLaVA">
<meta name="description" content="LLaVA-1.5悟道
LLaVA-1.5在LLaVA的基础上做了一小部分修改。模型上把之前的线性层换成了MLP，visual encoder从ViT-L-14换成了ViT-L-14-336px，数据集进行了扩充（Visual Instruction Tuning从158K涨到了665K）
论文贡献
论文主要贡献：

验证了LLaVA架构的高效性：使用最少的计算量和数据达到了更优的性能
简单修改了LLaVA的架构
在prompt中明确回复格式以平衡模型的长短回复
分析了分辨率、数据规模和LLM大小对性能的影响

网络架构
整体架构上没有太大的改变，如下图所示：

LLaVA v1.5.(Image source:LLaVA v1.5)
很重要的一点，是作者使用了AnyRes策略，来拓展视觉的分辨率（因为CLIP支持的最大分辨率是336px）

LLaVA v1.5 HD.(Image source:LLaVA v1.5)
AnyRes策略的具体步骤：

将高分辨率图像切分成块，每块的大小取决于visual encoder能处理的分辨率大小。visual encoder单独处理每一块
将高分辨图像resize成visual encoder可以处理的大小进行编码
将上面两步的结果拼接起来一起作为视觉特征

在LLM中，模型的幻觉归因于训练数据集中的错误或幻觉。作者认为输入分辨率不足以让模型识别数据中的所有细节，模型就会产生幻觉。
数据集规模

Instruction-following Data.(Image source:LLaVA v1.5)

LLaVA-NEXT
与LLaVA-1.5相比，主要有以下提升：">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/llava_02/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/llava_02/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            },
            "HTML-CSS": {
                availableFonts: ["Arial", "TeX"],
                preferredFont: "TeX",
                webFont: "TeX"
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>


</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="JiaHe&#39;s Blog (Alt + H)">JiaHe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="All posts">
                    <span>All posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      从零开始学LLaVA 02
    </h1>
    <div class="post-meta"><span title='2024-11-01 18:21:23 +0800 CST'>十一月 1, 2024</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#llava-15%e6%82%9f%e9%81%93" aria-label="LLaVA-1.5悟道">LLaVA-1.5悟道</a><ul>
                            
                    <li>
                        <a href="#%e8%ae%ba%e6%96%87%e8%b4%a1%e7%8c%ae" aria-label="论文贡献">论文贡献</a></li>
                    <li>
                        <a href="#%e7%bd%91%e7%bb%9c%e6%9e%b6%e6%9e%84" aria-label="网络架构">网络架构</a></li>
                    <li>
                        <a href="#%e6%95%b0%e6%8d%ae%e9%9b%86%e8%a7%84%e6%a8%a1" aria-label="数据集规模">数据集规模</a></li></ul>
                    </li>
                    <li>
                        <a href="#llava-next" aria-label="LLaVA-NEXT">LLaVA-NEXT</a></li>
                    <li>
                        <a href="#%e6%9e%84%e9%80%a0%e5%a4%9a%e6%a8%a1%e6%80%81%e6%95%b0%e6%8d%ae" aria-label="构造多模态数据">构造多模态数据</a><ul>
                            
                    <li>
                        <a href="#conversation%e6%9e%84%e9%80%a0" aria-label="Conversation构造">Conversation构造</a></li>
                    <li>
                        <a href="#detailed-description%e6%9e%84%e9%80%a0" aria-label="Detailed description构造">Detailed description构造</a></li>
                    <li>
                        <a href="#complex-reasonging%e6%9e%84%e9%80%a0" aria-label="Complex reasonging构造">Complex reasonging构造</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%84%e7%90%86%e6%95%b0%e6%8d%ae" aria-label="处理数据">处理数据</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="llava-15悟道">LLaVA-1.5悟道<a hidden class="anchor" aria-hidden="true" href="#llava-15悟道">#</a></h1>
<p>LLaVA-1.5在LLaVA的基础上做了一小部分修改。模型上把之前的线性层换成了MLP，visual encoder从ViT-L-14换成了ViT-L-14-336px，数据集进行了扩充（Visual Instruction Tuning从158K涨到了665K）</p>
<h2 id="论文贡献">论文贡献<a hidden class="anchor" aria-hidden="true" href="#论文贡献">#</a></h2>
<p>论文主要贡献：</p>
<ul>
<li>验证了LLaVA架构的高效性：使用最少的计算量和数据达到了更优的性能</li>
<li>简单修改了LLaVA的架构</li>
<li>在prompt中明确回复格式以平衡模型的长短回复</li>
<li>分析了分辨率、数据规模和LLM大小对性能的影响</li>
</ul>
<h2 id="网络架构">网络架构<a hidden class="anchor" aria-hidden="true" href="#网络架构">#</a></h2>
<p>整体架构上没有太大的改变，如下图所示：</p>
<center><img src="/img/LLaVA_02/LLaVA-1.5.png" width="70%" title=""></center>
<center>LLaVA v1.5.(Image source:<a href="https://arxiv.org/abs/2310.03744">LLaVA v1.5</a>)</center><br/>
<p>很重要的一点，是作者使用了AnyRes策略，来拓展视觉的分辨率（因为CLIP支持的最大分辨率是336px）</p>
<center><img src="/img/LLaVA_02/AnyRes.png" width="70%" title=""></center>
<center>LLaVA v1.5 HD.(Image source:<a href="https://arxiv.org/abs/2310.03744">LLaVA v1.5</a>)</center><br/>
<p>AnyRes策略的具体步骤：</p>
<ul>
<li>将高分辨率图像切分成块，每块的大小取决于visual encoder能处理的分辨率大小。visual encoder单独处理每一块</li>
<li>将高分辨图像resize成visual encoder可以处理的大小进行编码</li>
<li>将上面两步的结果拼接起来一起作为视觉特征</li>
</ul>
<p>在LLM中，模型的幻觉归因于训练数据集中的错误或幻觉。作者认为输入分辨率不足以让模型识别数据中的所有细节，模型就会产生幻觉。</p>
<h2 id="数据集规模">数据集规模<a hidden class="anchor" aria-hidden="true" href="#数据集规模">#</a></h2>
<center><img src="/img/LLaVA_02/Instruction data.png" width="70%" title=""></center>
<center>Instruction-following Data.(Image source:<a href="https://arxiv.org/abs/2310.03744">LLaVA v1.5</a>)</center><br/>
<hr>
<h1 id="llava-next">LLaVA-NEXT<a hidden class="anchor" aria-hidden="true" href="#llava-next">#</a></h1>
<p>与LLaVA-1.5相比，主要有以下提升：</p>
<ul>
<li>将输入图像分辨率提高 4 倍，使得它能够捕捉更多的视觉细节。它支持 3 种不同比例的分辨率，分别是 672x672、336x1344、1344x336</li>
<li>改变视觉指令微调数据的比例，实现更好的视觉推理和 OCR 能力</li>
<li>更好的视觉对话，适用于更多场景，涵盖不同应用</li>
<li>使用 SGLang 实现高效部署和推理</li>
</ul>
<hr>
<h1 id="构造多模态数据">构造多模态数据<a hidden class="anchor" aria-hidden="true" href="#构造多模态数据">#</a></h1>
<p>常言道：“工欲善其事，必先利其器。”LLaVA这篇论文的另一个核心贡献就是在于将图像文本对转换成了多模态instruction-following数据。LLaVA构造了三种多模态instruction-following数据：</p>
<ul>
<li>对话（Conversation）</li>
<li>细节描述（Detailed description）</li>
<li>复杂推理（Complex reasoning）</li>
</ul>
<h2 id="conversation构造">Conversation构造<a hidden class="anchor" aria-hidden="true" href="#conversation构造">#</a></h2>
<p>构造的思路如下：</p>
<ul>
<li>给出一个system prompt，要求纯文本大模型根据图片的描述生成多轮对话</li>
<li>提供几个示例，便于纯文本大模型理解以及生成类似的多轮对话</li>
<li>将上面的内容输入给纯文本大模型，纯文本大模型返回多轮对话</li>
</ul>
<p>system prompt和示例的内容可以见<code>LLaVA/playground/data/prompts</code>，在LLaVA论文中也给出了构造数据的示例代码：</p>
<center><img src="/img/LLaVA_02/sample_codes.png" width="70%" title=""></center>
<center>Sample Codes.(Image source:<a href="https://arxiv.org/abs/2304.08485">LLaVA</a>)</center><br/>
<p>我这里由于没有gpt4的api，所以决定用llama3来代替，使用了vllm框架</p>
<p>具体的代码实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#2f1e2e;background-color:#e7e9db;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8d8687"># 先启动服务</span>
</span></span><span style="display:flex;"><span><span style="color:#8d8687"># python3 -m vllm.entrypoints.openai.api_server --model ./Meta-Llama-3-8B-Instruct --dtype auto --api-key 123456</span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">from</span> <span style="color:#fec418">openai</span> <span style="color:#5bc4bf">import</span> OpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openai_api_key <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;123456&#34;</span>  <span style="color:#8d8687"># Same as --api-key in the deployment command</span>
</span></span><span style="display:flex;"><span>openai_api_base <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;http://localhost:8000/v1&#34;</span>
</span></span><span style="display:flex;"><span>client <span style="color:#5bc4bf">=</span> OpenAI(api_key<span style="color:#5bc4bf">=</span>openai_api_key, base_url<span style="color:#5bc4bf">=</span>openai_api_base)
</span></span><span style="display:flex;"><span>model <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;./Meta-Llama-3-8B-Instruct&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SYSTEM_CONTENT <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">You are an AI visual assistant, and you are seeing a single image. What you see are provided with five sentences, describing the same image you are looking at. Answer all questions as you are seeing the image.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Design a conversation between you and a person asking about this photo. The answers should be in a tone that a visual AI assistant is seeing the image and answering the question.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Ask diverse questions and give corresponding answers.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Include questions asking about the visual content of the image, including the object types, counting the objects, object actions, object locations, relative positions between objects, etc. Only include questions that have definite answers:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">(1) one can see the content in the image that the question asks about and can answer confidently;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">(2) one can determine confidently from the image that it is not in the image.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Do not ask any question that cannot be answered confidently.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Also include complex questions that are relevant to the content in the image, for example, asking about background knowledge of the objects in the image, asking to discuss about events happening in the image, etc. Again, do not ask about uncertain details.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Provide detailed answers when answering complex questions. For example, give detailed examples or reasoning steps to make the content more convincing and well-organized.  You can include multiple paragraphs if necessary.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SAMPLE_CONTENT_1 <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">There is a movie theater that displays the show times above the doors.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A red fire hydrant is deep in the snow.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The fire hydrant is in the snow near a recently plowed sidewalk.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">This city has had a very hard winter with snow.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A hotel for dogs in the snow in winter.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SAMPLE_RESPONSE_1 <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">What color is the fire hydrant in the image?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The fire hydrant in the image is red.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Is the fire hydrant fully covered by snow or partially visible?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The fire hydrant is partially visible, with a significant portion of it covered by the deep snow.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">What is the condition of the sidewalk near the fire hydrant?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The sidewalk near the fire hydrant has been recently plowed, so it is relatively clear of snow compared to the surrounding area.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">What does the image suggest about the winter season in the city?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The image suggests that the winter season in the city has been quite harsh and challenging. The significant snow accumulation seen in the image indicates that the city has experienced heavy snowfall, which can lead to various difficulties and disruptions for its residents. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">For instance, the deep snow covering the fire hydrant could potentially hinder its accessibility in case of emergencies, which poses safety concerns. The recently plowed sidewalk implies that the city&#39;s maintenance crews have been actively working to keep the walkways clear and safe for pedestrians, but the sheer amount of snowfall might make it difficult to keep up with the continuous snow removal efforts. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Furthermore, such extreme winter conditions can impact transportation, leading to traffic issues, delays in public transit, and increased risks of accidents due to slippery roads. It can also cause problems for businesses and schools, as people might face challenges commuting to work or attending classes. Additionally, the heavy snow can put extra strain on infrastructure, such as roofs and power lines, increasing the likelihood of structural damage or power outages. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">In conclusion, the image of the red fire hydrant deep in the snow and the recently plowed sidewalk suggest that the city has faced a particularly severe winter season, with substantial snowfall that has likely caused various challenges and disruptions for its residents and infrastructure.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SAMPLE_CONTENT_2 <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A man is skiing in the open snow covered hills
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A skier is making his way into the snow.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A skier on the foothills of a huge mountain range.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A skier looks at mountains while standing near a trail sign.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">a single person skiing by an area with a lot of bushes
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SAMPLE_RESPONSE_2 <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">What is the skier doing?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The skier is skiing in the snow-covered hills, making his way through the snow and enjoying the beautiful mountain scenery. They are also standing near a trail sign, which indicates their location on the mountain.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Are there any other people or skiers visible in the image?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">No, there is only a single person skiing in the image, and they are surrounded by an area with a lot of bushes.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">What kind of skiing is the person doing? Cross-country or downhill?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Based on what I can see in the photo, it is not possible to definitively determine whether the skier is doing cross-country or downhill skiing. However, given the presence of a trail sign and the fact that they are skiing in the foothills, it is more likely that the skier is engaged in cross-country skiing. Downhill skiing typically takes place on more steep slopes and involves ski lifts, whereas cross-country skiing often occurs on relatively flatter terrain with marked trails.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Question:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Can you explain cross-country and downhill skiing a bit more?
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">===
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Answer:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Cross-country skiing and downhill skiing are two distinct types of skiing, each with its own techniques, equipment, and terrain preferences. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">1. Cross-Country Skiing:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Also known as Nordic skiing, cross-country skiing involves traversing relatively flat terrain or gentle slopes using skis and poles. It is a popular recreational and competitive sport that focuses on endurance, balance, and aerobic fitness. Cross-country skiers use their own locomotion to move across snow-covered terrain, rather than relying on ski lifts or other forms of assistance. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">There are two main techniques in cross-country skiing:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">- Classic: This technique involves skiing in parallel tracks, using a forward-and-backward gliding motion while keeping the skis parallel to each other. The skier uses their poles to propel themselves forward.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">- Skate skiing: This technique is similar to ice skating, where the skier pushes off one ski at an angle and glides on the other. It requires a smooth, groomed surface and is typically faster than the classic technique. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Cross-country ski equipment consists of lightweight skis, boots, bindings, and poles. The boots are more flexible than those used in downhill skiing, allowing for better ankle movement and control. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">2. Downhill Skiing:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Also known as alpine skiing, downhill skiing involves descending slopes at high speeds using skis and poles for balance and control. This sport is more focused on speed, technique, and navigating challenging terrain, including steep slopes, moguls, and even jumps. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Downhill skiing can be further categorized into several disciplines, such as slalom, giant slalom, super-G, and downhill racing. Each discipline has its own set of rules, courses, and ski equipment. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Downhill ski equipment includes heavier and stiffer skis, boots, bindings, and poles than those used in cross-country skiing. The boots are more rigid to provide better support and control during high-speed descents and sharp turns. 
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">In summary, cross-country skiing is an endurance-based sport that involves traveling across flat or gently sloping terrain, while downhill skiing is focused on speed and technique as skiers navigate steeper slopes and challenging terrain. Both sports require specialized equipment and techniques, but they offer different experiences and challenges to participants.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;system&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;content&#39;</span>: SYSTEM_CONTENT,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fewshot_samples <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;context&#39;</span>: SAMPLE_CONTENT_1,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;response&#39;</span>: SAMPLE_RESPONSE_1,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;context&#39;</span>: SAMPLE_CONTENT_2,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;response&#39;</span>: SAMPLE_RESPONSE_2,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">for</span> sample <span style="color:#5bc4bf">in</span> fewshot_samples:
</span></span><span style="display:flex;"><span>    messages<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;user&#39;</span>, <span style="color:#48b685">&#39;content&#39;</span>: sample[<span style="color:#48b685">&#39;context&#39;</span>]})
</span></span><span style="display:flex;"><span>    messages<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;assistant&#39;</span>, <span style="color:#48b685">&#39;content&#39;</span>: sample[<span style="color:#48b685">&#39;response&#39;</span>]})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A group of people standing outside of a black vehicle with various luggage.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Luggage surrounds a vehicle in an underground parking area
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">People try to fit all of their luggage in an SUV.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The sport utility vehicle is parked in the public garage, being packed for a trip
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Some people with luggage near a van that is transporting it.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>messages<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#34;role&#34;</span>:<span style="color:#48b685">&#34;user&#34;</span>, <span style="color:#48b685">&#34;content&#34;</span>: query})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#5bc4bf">=</span> client<span style="color:#5bc4bf">.</span>chat<span style="color:#5bc4bf">.</span>completions<span style="color:#5bc4bf">.</span>create(model<span style="color:#5bc4bf">=</span>model, messages<span style="color:#5bc4bf">=</span>messages)<span style="color:#5bc4bf">.</span>choices[<span style="color:#f99b15">0</span>]<span style="color:#5bc4bf">.</span>message<span style="color:#5bc4bf">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(response)
</span></span></code></pre></div><p>使用Llama3-8B-Instruct生成的问答数据如下所示：</p>
<pre tabindex="0"><code>Question:
What type of vehicle is being packed with luggage?
===
Answer:
The vehicles being packed with luggage are a black SUV (sport utility vehicle) and a van.
===
Question:
Where is the luggage being packed into the vehicle(s)?
===
Answer:
The luggage is being packed into the vehicles in an underground parking area, as well as in a public garage.
===
Question:
How many people are trying to fit their luggage into the vehicle?
===
Answer:
It appears that there is a group of people trying to fit their luggage into the SUV, but the exact number is not clear from the image.
===
Question:
What is the purpose of the people packing their luggage into the vehicle(s)?
===
Answer:
Based on the context of the image, it appears that the people are packing their luggage into the vehicles in preparation for a trip. The luggage and the vehicles suggest that they are likely going on a vacation or a long journey, and the underground parking area and public garage suggest that they are preparing to leave from a city or urban area.
===
Question:
Can you explain the importance of underground parking and public garages in urban areas?
===
Answer:
Yes, certainly! Underground parking and public garages play a crucial role in urban areas, especially in cities with limited street parking and high population density. These structures provide a convenient and secure way for residents and visitors to park their vehicles, reducing the need for on-street parking and minimizing the visual impact of parked cars on the urban landscape.

Underground parking garages, in particular, offer a range of benefits, including:
* Protection from the elements: Cars are shielded from inclement weather, reducing the risk of damage and making it easier to maintain the vehicles.
* Security: Underground parking garages often have controlled access, surveillance cameras, and secure entry/exit points, providing a safer environment for parked vehicles and their occupants.
* Convenience: Underground parking garages are often located near public transportation hubs, commercial centers, and residential areas, making it easier for people to park and access their destinations.
* Urban planning: Underground parking garages can help to reduce the visual impact of parking on urban streets, freeing up surface areas for other uses and helping to create more pedestrian-friendly and aesthetically pleasing public spaces.

In the context of the image, the underground parking area and public garage suggest that the people are preparing to leave from a city or urban area, and the presence of luggage and vehicles confirms that they are embarking on a trip.
</code></pre><h2 id="detailed-description构造">Detailed description构造<a hidden class="anchor" aria-hidden="true" href="#detailed-description构造">#</a></h2>
<p>构造的方式与上面基本相同，只是此处使用到了论文提到的锚框</p>
<div class="highlight"><pre tabindex="0" style="color:#2f1e2e;background-color:#e7e9db;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5bc4bf">from</span> <span style="color:#fec418">openai</span> <span style="color:#5bc4bf">import</span> OpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openai_api_key <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;123456&#34;</span>  <span style="color:#8d8687"># Same as --api-key in the deployment command</span>
</span></span><span style="display:flex;"><span>openai_api_base <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;http://localhost:8000/v1&#34;</span>
</span></span><span style="display:flex;"><span>client <span style="color:#5bc4bf">=</span> OpenAI(api_key<span style="color:#5bc4bf">=</span>openai_api_key, base_url<span style="color:#5bc4bf">=</span>openai_api_base)
</span></span><span style="display:flex;"><span>model <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;./Meta-Llama-3-8B-Instruct&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>system_content_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/system_message.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_content_0_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/000_caps.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_response_0_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/000_conv.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_content_1_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/001_caps.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_response_1_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/001_conv.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_content_2_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/002_caps.txt&#39;</span>
</span></span><span style="display:flex;"><span>sample_response_2_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#39;LLaVA/playground/data/prompts/detail_description/002_conv.txt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(system_content_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SYSTEM_CONTENT <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_content_0_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_CONTENT_0 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_response_0_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_RESPONSE_0 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_content_1_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_CONTENT_1 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_response_1_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_RESPONSE_1 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_content_2_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_CONTENT_2 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(sample_response_2_path, <span style="color:#48b685">&#39;r&#39;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    SAMPLE_RESPONSE_2 <span style="color:#5bc4bf">=</span> f<span style="color:#5bc4bf">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>message <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;system&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;content&#39;</span>: SYSTEM_CONTENT,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fewshot_samples <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;context&#39;</span>: SAMPLE_CONTENT_0,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;response&#39;</span>: SAMPLE_RESPONSE_0,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;context&#39;</span>: SAMPLE_CONTENT_1,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;response&#39;</span>: SAMPLE_RESPONSE_1,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;context&#39;</span>: SAMPLE_CONTENT_2,
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#39;response&#39;</span>: SAMPLE_RESPONSE_2,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">for</span> sample <span style="color:#5bc4bf">in</span> fewshot_samples:
</span></span><span style="display:flex;"><span>    message<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;user&#39;</span>, <span style="color:#48b685">&#39;content&#39;</span>: sample[<span style="color:#48b685">&#39;context&#39;</span>]})
</span></span><span style="display:flex;"><span>    message<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;assistant&#39;</span>, <span style="color:#48b685">&#39;content&#39;</span>: sample[<span style="color:#48b685">&#39;response&#39;</span>]})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">A group of people standing outside of a black vehicle with various luggage.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Luggage surrounds a vehicle in an underground parking area
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">People try to fit all of their luggage in an SUV.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">The sport utility vehicle is parked in the public garage, being packed for a trip
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">Some people with luggage near a van that is transporting it.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">person: [0.681, 0.242, 0.774, 0.694]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">person: [0.63, 0.222, 0.686, 0.516]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">person: [0.444, 0.233, 0.487, 0.34]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">backpack: [0.384, 0.696, 0.485, 0.914]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">backpack: [0.755, 0.413, 0.846, 0.692]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">suitcase: [0.758, 0.413, 0.845, 0.69]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">suitcase: [0.1, 0.497, 0.173, 0.579]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">bicycle: [0.282, 0.363, 0.327, 0.442]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">car: [0.786, 0.25, 0.848, 0.322]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">car: [0.783, 0.27, 0.827, 0.335]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">car: [0.86, 0.254, 0.891, 0.3]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">car: [0.261, 0.101, 0.787, 0.626]
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>message<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#39;role&#39;</span>: <span style="color:#48b685">&#39;user&#39;</span>, <span style="color:#48b685">&#39;content&#39;</span>: query})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#5bc4bf">=</span> client<span style="color:#5bc4bf">.</span>chat<span style="color:#5bc4bf">.</span>completions<span style="color:#5bc4bf">.</span>create(model<span style="color:#5bc4bf">=</span>model, messages<span style="color:#5bc4bf">=</span>message)<span style="color:#5bc4bf">.</span>choices[<span style="color:#f99b15">0</span>]<span style="color:#5bc4bf">.</span>message<span style="color:#5bc4bf">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(response)
</span></span></code></pre></div><p>Llama3-8B-Instruct生成的数据如下：</p>
<pre tabindex="0"><code>This image shows a group of people standing outside a black vehicle, likely an SUV, in an underground parking area. The vehicle is being packed for a trip, with various luggage items scattered around it. There are multiple backpacks and suitcases, with one suitcase sitting near the front of the vehicle and another leaning against the side.

The people in the image are attempting to fit all of their luggage into the SUV, with one person standing close to the left side of the vehicle, another near the middle, and a third person on the right side. A bicycle can be seen parked nearby, possibly belonging to one of the individuals.

The parking area is dimly lit, with the only light source coming from the fluorescent lights above. The walls of the garage are made of concrete, and there is a chair or bench in the background.
</code></pre><h2 id="complex-reasonging构造">Complex reasonging构造<a hidden class="anchor" aria-hidden="true" href="#complex-reasonging构造">#</a></h2>
<p>这部分的构造和Detailed description的代码完全相同，我们直接展示Llama3-8B-Instruct生成的结果：</p>
<pre tabindex="0"><code>Question:
What might be the purpose of this group of people and their luggage?
===
Answer:
Based on the image, it appears that this group of people is preparing for a trip. The various luggage, including suitcases, backpacks, and possibly even a bicycle, suggests that they are packing for a journey. The fact that they are surrounded by luggage and trying to fit everything into an SUV or van also implies that they are getting ready to depart. The presence of a public garage, with multiple vehicles parked, further supports this conclusion. It is likely that this group is planning a trip, possibly a family vacation or a business trip, and they are busy packing and preparing for their departure.
</code></pre><hr>
<h1 id="处理数据">处理数据<a hidden class="anchor" aria-hidden="true" href="#处理数据">#</a></h1>
<p>我们已经可以通过Llama3来根据query生成对应的response，但这种格式并不适合大批量训练，我们需要将response整理成训练格式</p>
<p>LLaVA的训练格式可以通过huggingface上开源的<a href="https://huggingface.co/datasets/liuhaotian/LLaVA-Instruct-150K">LLaVA-Instruct-150K</a>看到，所有样本以列表的形式保存在一个json文件中，其中每个样本是一个字典，包含三个字段：</p>
<ul>
<li>id：全局唯一的字符串</li>
<li>image：图片的路径</li>
<li>conversations：上面的对话</li>
</ul>
<p>代码的实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#2f1e2e;background-color:#e7e9db;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5bc4bf">import</span> <span style="color:#fec418">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image_path <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;path/to/123456.jpg&#34;</span>
</span></span><span style="display:flex;"><span>image_path <span style="color:#5bc4bf">=</span> os<span style="color:#5bc4bf">.</span>path<span style="color:#5bc4bf">.</span>basename(image_path)
</span></span><span style="display:flex;"><span>id <span style="color:#5bc4bf">=</span> os<span style="color:#5bc4bf">.</span>path<span style="color:#5bc4bf">.</span>splitext(image_path)[<span style="color:#f99b15">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conversations <span style="color:#5bc4bf">=</span> []
</span></span><span style="display:flex;"><span>response_lines <span style="color:#5bc4bf">=</span> response<span style="color:#5bc4bf">.</span>split(<span style="color:#48b685">&#34;===&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#815ba4">for</span> line <span style="color:#5bc4bf">in</span> response_lines:
</span></span><span style="display:flex;"><span>    line <span style="color:#5bc4bf">=</span> line<span style="color:#5bc4bf">.</span>strip()
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">if</span> line<span style="color:#5bc4bf">.</span>startswith(<span style="color:#48b685">&#34;Question:&#34;</span>):
</span></span><span style="display:flex;"><span>        question <span style="color:#5bc4bf">=</span> line<span style="color:#5bc4bf">.</span>replace(<span style="color:#48b685">&#34;Question:&#34;</span>, <span style="color:#48b685">&#34;&#34;</span>)<span style="color:#5bc4bf">.</span>strip()
</span></span><span style="display:flex;"><span>        conversations<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#34;from&#34;</span>: <span style="color:#48b685">&#34;human&#34;</span>, <span style="color:#48b685">&#34;value&#34;</span>: question})
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">elif</span> line<span style="color:#5bc4bf">.</span>startswith(<span style="color:#48b685">&#34;Answer:&#34;</span>):
</span></span><span style="display:flex;"><span>        answer <span style="color:#5bc4bf">=</span> line<span style="color:#5bc4bf">.</span>replace(<span style="color:#48b685">&#34;Answer:&#34;</span>, <span style="color:#48b685">&#34;&#34;</span>)<span style="color:#5bc4bf">.</span>strip()
</span></span><span style="display:flex;"><span>        conversations<span style="color:#5bc4bf">.</span>append({<span style="color:#48b685">&#34;from&#34;</span>: <span style="color:#48b685">&#34;gpt&#34;</span>, <span style="color:#48b685">&#34;value&#34;</span>: answer})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conversation_data <span style="color:#5bc4bf">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;id&#34;</span>: id, 
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;image&#34;</span>: image_path,
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;conversations&#34;</span>: conversations
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">import</span> <span style="color:#fec418">json</span>
</span></span><span style="display:flex;"><span>new_json <span style="color:#5bc4bf">=</span> <span style="color:#48b685">f</span><span style="color:#48b685">&#34;/path/to/conversation.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">with</span> open(new_json, <span style="color:#48b685">&#34;w&#34;</span>) <span style="color:#815ba4">as</span> f:
</span></span><span style="display:flex;"><span>    json<span style="color:#5bc4bf">.</span>dump([conversation_data], f, indent<span style="color:#5bc4bf">=</span><span style="color:#f99b15">4</span>)
</span></span></code></pre></div><p>构造完成过后的数据如下所示：</p>
<pre tabindex="0"><code>[
    {
        &#34;id&#34;: &#34;123456&#34;,
        &#34;image&#34;: &#34;123456.jpg&#34;,
        &#34;conversations&#34;: [
            {
                &#34;from&#34;: &#34;human&#34;,
                &#34;value&#34;: &#34;What type of vehicle is being packed with luggage?&#34;
            },
            {
                &#34;from&#34;: &#34;gpt&#34;,
                &#34;value&#34;: &#34;The vehicle being packed with luggage appears to be a sport utility vehicle (SUV).&#34;
            },
            {
                &#34;from&#34;: &#34;human&#34;,
                &#34;value&#34;: &#34;Where is the SUV being packed with luggage?&#34;
            },
            {
                &#34;from&#34;: &#34;gpt&#34;,
                &#34;value&#34;: &#34;The SUV is being packed with luggage in a public garage, likely an underground parking area.&#34;
            },
            {
                &#34;from&#34;: &#34;human&#34;,
                &#34;value&#34;: &#34;Are all the people shown in the image packing the luggage into the SUV?&#34;
            },
            {
                &#34;from&#34;: &#34;gpt&#34;,
                &#34;value&#34;: &#34;No, it appears that there are multiple people trying to fit all of their luggage into the SUV, suggesting that there may be a group of travelers preparing for a trip.&#34;
            },
            {
                &#34;from&#34;: &#34;human&#34;,
                &#34;value&#34;: &#34;Can you describe the scene and the people&#39;s actions?&#34;
            },
            {
                &#34;from&#34;: &#34;gpt&#34;,
                &#34;value&#34;: &#34;The scene depicts a chaotic and busy atmosphere, with multiple people attempting to pack and fit their luggage into the SUV. The luggage surrounds the vehicle, and some people are trying to squeeze more bags into the already-packed vehicle. It appears that the group is in a rush to prepare for a trip and is working together to get everything loaded.\n\nThe people in the image are likely a group of travelers, possibly a family or friends, who are preparing for a trip. They are all working together to fit their luggage into the SUV, which suggests a sense of teamwork and cooperation. The scene is quite busy and potentially stressful, as the group is trying to pack a large amount of luggage into a relatively small vehicle.\n\nOverall, the image conveys a sense of chaos and busyness, but also a sense of camaraderie and teamwork as the group works together to prepare for their trip.&#34;
            }
        ]
    }
]
</code></pre><hr>
<h1 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h1>
<p>[1] Paper:Improved Baselines with Visual Instruction Tuning(<a href="https://arxiv.org/abs/2310.03744">https://arxiv.org/abs/2310.03744</a>)</p>
<p>[2] Blog:LLaVA-NeXT(<a href="https://llava-vl.github.io/blog/2024-01-30-llava-next/">https://llava-vl.github.io/blog/2024-01-30-llava-next/</a>)</p>
<p>[3] Zhihu:HelloWorld-构造多模态数据(<a href="https://zhuanlan.zhihu.com/p/696831022">https://zhuanlan.zhihu.com/p/696831022</a>)</p>
<p>[4] Zhihu:HelloWorld-LLaVA1.5论文解读(<a href="https://zhuanlan.zhihu.com/p/696402890">https://zhuanlan.zhihu.com/p/696402890</a>)</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/vision-language-models/">Vision-Language-Models</a></li>
      <li><a href="http://localhost:1313/tags/llava/">LLaVA</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">JiaHe&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
